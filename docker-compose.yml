services:
  # -------------------------------------------------------------------
  # Agente de procesamiento (conecta con la base ETL y MinIO)
  # -------------------------------------------------------------------
  agente:
    build:
      context: ./agent
      dockerfile: Dockerfile
    ports:
      - 8000:8000
    environment:
      PG_DSN: postgresql+psycopg2://postgres:etl_pass@database_etl:5432/paaa_etl        # REVISAR PARA REQUESTS DE POSTMAN
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123
      MINIO_BUCKET: paaa-bucket
      MINIO_SECURE: "false"
    depends_on:
      database_etl:
        condition: service_healthy
    networks:
      - app_net

  # -------------------------------------------------------------------
  # Base de datos de usuarios
  # -------------------------------------------------------------------
  database_users:
    image: postgres:15
    container_name: users-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: paadb_users
    ports:
      - "5432:5432"
    volumes:
      - db_users_data:/var/lib/postgresql/data
      - ./db:/docker-entrypoint-initdb.d
      #- ./db/01-init.sql:/docker-entrypoint-initdb.d/01-init.sql   # Ejecutado automáticamente SOLO la primera vez
      #- ./db/02-users.sql:/docker-entrypoint-initdb.d/02-users.sql   # Ejecutado automáticamente SOLO la primera vez
    networks:
      - app_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -------------------------------------------------------------------
  # Base de datos ETL (datos procesados)
  # -------------------------------------------------------------------
  database_etl:
    image: postgres:15
    container_name: etl-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: paadb_data
    ports:
      - "5433:5432"
    volumes:
      - db_etl_data:/var/lib/postgresql/data
      - ./db/02-etl.sql:/docker-entrypoint-initdb.d/02-etl.sql       # Script vacío (temporalmente)
    networks:
      - app_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -------------------------------------------------------------------
  # Documentación interna (pgAdmin)
  # -------------------------------------------------------------------
  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: miguel@correo.com
      PGADMIN_DEFAULT_PASSWORD: test
    ports:
      - 5050:80
    depends_on:
      - database_users
      - database_etl
    networks:
      - app_net

  # -------------------------------------------------------------------
  # Almacenamiento de archivos (MinIO)
  # -------------------------------------------------------------------
  minio:
    image: minio/minio:RELEASE.2024-06-13T22-53-53Z
    container_name: paaa-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - minio_data:/data
      - ./MINIO/init.sh:/usr/local/bin/init-minio.sh
    networks:
      - app_net
    depends_on:
      - agente

  # -------------------------------------------------------------------
  # Backend (Python / FastAPI)
  # -------------------------------------------------------------------
  backend:
    build:
      context: ./backend
    container_name: paaa-backend
    env_file:
      - ./backend/.env
    ports:
      - "8001:8000"
    depends_on:
      - database_users
      - database_etl
      - minio
    networks:
      - app_net
    volumes:
      - ./backend:/code

  # -------------------------------------------------------------------
  # Frontend (React / Vite)
  # -------------------------------------------------------------------
  frontend:
    build: ./frontend
    container_name: paaa-frontend
    ports:
      - "5173:80"
    networks:
      - app_net

# =====================================================================
# NOTA IMPORTANTE:
# Los scripts *.sql montados en /docker-entrypoint-initdb.d
# se ejecutan AUTOMÁTICAMENTE solo la primera vez que se crea
# el volumen de datos de Postgres. Si ya existe el volumen,
# no se volverán a ejecutar.
#
# Para recargar datos manualmente:
#    bash scripts/load-data.sh
#
# Para forzar reejecución automática (reinicialización completa):
#    docker compose down -v
#    docker compose up --build
# =====================================================================

# ---------------------------
# Volúmenes persistentes
# ---------------------------
volumes:
  db_users_data:
  db_etl_data:
  minio_data:

# ---------------------------
# Red compartida
# ---------------------------
networks:
  app_net:
